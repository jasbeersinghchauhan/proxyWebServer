<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proxy Log Analyzer</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- GLOBAL STYLES --- */
      body {
        font-family: "Inter", sans-serif;
        background-color: #111827;
        color: #f3f4f6;
        margin: 0;
        padding: 1.5rem;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* --- HEADER --- */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #22d3ee;
        margin: 0;
      }

      .subtitle {
        color: #9ca3af;
        font-size: 0.875rem;
      }

      /* --- DROP ZONE --- */
      #dropZone {
        background-color: #1f2937;
        border: 2px dashed #4b5563;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition:
          background-color 0.2s,
          border-color 0.2s;
        margin-bottom: 2rem;
      }

      #dropZone:hover {
        background-color: #374151;
      }

      #dropZone.drag-over {
        border-color: #3b82f6;
        background-color: #374151;
      }

      #dropZone svg {
        height: 48px;
        width: 48px;
        color: #9ca3af;
        margin-bottom: 1rem;
      }

      #dropZone p {
        margin: 0.5rem 0;
      }

      #dropZone .highlight {
        color: #22d3ee;
        font-weight: 600;
      }

      #fileName {
        color: #9ca3af;
        font-size: 0.875rem;
        margin-top: 0.5rem;
      }

      /* --- STATS GRID --- */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .card {
        background-color: #1f2937;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #374151;
      }

      .card h3 {
        color: #9ca3af;
        font-size: 0.875rem;
        font-weight: 500;
        margin: 0 0 0.5rem 0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .card p {
        font-size: 2.25rem;
        font-weight: 700;
        margin: 0;
        color: #f3f4f6;
      }

      #hitRate {
        color: #22c55e;
      }

      /* --- DASHBOARD --- */
      .dashboard {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      @media (min-width: 1024px) {
        .dashboard {
          grid-template-columns: 1fr 2fr;
        }
      }

      .panel {
        background-color: #1f2937;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #374151;
        display: flex;
        flex-direction: column;
      }

      .panel h2 {
        font-size: 1.25rem;
        margin: 0 0 1.5rem 0;
        color: #fff;
        font-weight: 600;
        border-bottom: 1px solid #374151;
        padding-bottom: 1rem;
      }

      #cacheChartContainer {
        position: relative;
        height: 300px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #chartError {
        text-align: center;
        color: #6b7280;
        font-style: italic;
        display: none;
      }

      /* --- LOG FEED (Fixed Layout) --- */
      #logFeed {
        height: 400px;
        overflow-y: auto;
        background-color: #111827;
        border-radius: 6px;
        padding: 0.5rem;
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 0.8rem;
        border: 1px solid #374151;
      }

      /* Feed Scrollbar */
      #logFeed::-webkit-scrollbar {
        width: 8px;
      }
      #logFeed::-webkit-scrollbar-track {
        background: #111827;
      }
      #logFeed::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      #logFeed::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      .log-entry {
        display: flex;
        align-items: flex-start;
        padding: 4px 0;
        border-bottom: 1px solid #1f2937;
        gap: 12px;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      /* FIXED COLUMNS: Prevent flexbox crushing */
      .log-time {
        color: #6b7280;
        width: 85px;          /* Fixed width */
        flex-shrink: 0;       /* Prevent shrinking */
        white-space: nowrap;  /* No wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .log-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 0;
        width: 80px;          /* Fixed width */
        flex-shrink: 0;       /* Prevent shrinking */
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.7rem;
        text-transform: uppercase;
        white-space: nowrap;
      }

      .log-client {
        color: #d1d5db;
        width: 90px;          /* Fixed width */
        flex-shrink: 0;       /* Prevent shrinking */
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .log-msg {
        color: #9ca3af;
        word-break: break-all;
        white-space: pre-wrap;
        flex-grow: 1;         /* Take remaining space */
        min-width: 0;         /* Critical for text overflow in flex */
      }

      /* Badge Colors */
      .bg-green { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); }
      .bg-red { background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
      .bg-yellow { background: rgba(234, 179, 8, 0.15); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.2); }
      .bg-purple { background: rgba(168, 85, 247, 0.15); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.2); }
      .bg-blue { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }
      .bg-gray { background: #374151; color: #9ca3af; border: 1px solid #4b5563; }
      .text-highlight { color: #22d3ee; }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <div>
          <h1>Proxy Log Analyzer</h1>
          <span class="subtitle">Fixed Layout & Robust Timestamp Parsing</span>
        </div>
      </div>

      <div id="dropZone">
        <input
          type="file"
          id="fileInput"
          style="display: none"
          accept=".log, .txt"
        />
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"
          />
        </svg>
        <p>
          Drop <code>proxy.log</code> here or
          <span class="highlight">click to upload</span>
        </p>
        <p id="fileName">No file selected</p>
      </div>

      <div class="stats-grid">
        <div class="card">
          <h3>Total Requests</h3>
          <p id="totalRequests">0</p>
        </div>
        <div class="card">
          <h3>Cache Hit Rate</h3>
          <p id="hitRate">0%</p>
        </div>
        <div class="card">
          <h3>Cache Hits</h3>
          <p id="cacheHits">0</p>
        </div>
        <div class="card">
          <h3>Cache Misses</h3>
          <p id="cacheMisses">0</p>
        </div>
        <div class="card">
          <h3>HTTPS Tunnels</h3>
          <p id="httpsTunnels">0</p>
        </div>
      </div>

      <div class="dashboard">
        <div class="panel">
          <h2>Cache Performance</h2>
          <div id="cacheChartContainer">
            <canvas id="cacheChart"></canvas>
            <p id="chartError">Waiting for data...</p>
          </div>
        </div>

        <div class="panel">
          <h2>Live Log Feed</h2>
          <div id="logFeed">
            <div style="text-align: center; color: #6b7280; padding-top: 2rem">
              Upload a log file to view parsed entries here.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const fileNameEl = document.getElementById("fileName");
      const totalRequestsEl = document.getElementById("totalRequests");
      const hitRateEl = document.getElementById("hitRate");
      const cacheHitsEl = document.getElementById("cacheHits");
      const cacheMissesEl = document.getElementById("cacheMisses");
      const httpsTunnelsEl = document.getElementById("httpsTunnels");
      const logFeedEl = document.getElementById("logFeed");
      const chartErrorEl = document.getElementById("chartError");
      const chartCtx = document.getElementById("cacheChart").getContext("2d");

      let cacheChart = null;

      // --- Event Listeners ---
      dropZone.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) handleFile(e.target.files[0]);
      });

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
      });

      dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        if (e.dataTransfer.files.length > 0)
          handleFile(e.dataTransfer.files[0]);
      });

      function handleFile(file) {
        if (!file) return;
        fileNameEl.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => parseLog(e.target.result);
        reader.onerror = () => (fileNameEl.textContent = "Error reading file");
        reader.readAsText(file);
      }

      // --- Parsing Logic ---
      function parseLog(logText) {
        const stats = {
          totalRequests: 0,
          cacheHits: 0,
          cacheMisses: 0,
          httpsTunnels: 0,
        };

        const logEntries = [];
        const lines = logText.split("\n").filter((l) => l.trim().length > 0);

        lines.forEach((line) => {
          try {
            // 1. Safe Timestamp Extraction
            // Finds the first ']' to separate the timestamp from the payload
            const splitIndex = line.indexOf(']');

            let timestamp = "--:--:--";
            let payload = line;

            if (splitIndex !== -1) {
              timestamp = line.substring(1, splitIndex).trim();
              payload = line.substring(splitIndex + 1).trim();
            }

            // 2. Split Payload by Pipe
            const parts = payload.split("|").map((p) => p.trim());
            const logLevel = parts[0];
            const component = parts[1];

            let clientDisplay = "";
            let badgeText = "";
            let badgeClass = "bg-gray";
            let message = "";

            // 3. Identify Type & Parse Columns
            if (component === "SERVER" || component === "CACHE") {
               clientDisplay = component;
               badgeText = logLevel;
               message = parts[2] || "";
               
               if(logLevel === "ERROR") badgeClass = "bg-red";
               else if(component === "CACHE") badgeClass = "bg-blue";

            } else if (component === "REMOTE") {
                clientDisplay = "REMOTE";
                badgeText = "ERROR";
                badgeClass = "bg-red";
                message = parts[2] || "";

            } else if (component === "CLIENT") {
              // INFO|CLIENT|123|SUB_TYPE|Message
              clientDisplay = `Client ${parts[2]}`;
              const subType = parts[3];
              message = parts[4] || "";

              badgeText = subType;

              // Categorize for Stats & Badge Color
              if (subType === "CACHE_HIT") {
                stats.cacheHits++;
                stats.totalRequests++;
                badgeClass = "bg-green";
                badgeText = "HIT";
              } else if (subType === "CACHE_MISS") {
                stats.cacheMisses++;
                stats.totalRequests++;
                badgeClass = "bg-yellow";
                badgeText = "MISS";
              } else if (subType === "CONNECT") {
                stats.httpsTunnels++;
                stats.totalRequests++;
                badgeClass = "bg-purple";
                badgeText = "HTTPS";
              } else if (subType === "HTTP") {
                stats.totalRequests++;
                badgeClass = "bg-blue";
                badgeText = "HTTP";
              } else {
                badgeText = logLevel;
                if(logLevel === "WARN") badgeClass = "bg-yellow";
                if(logLevel === "ERROR") badgeClass = "bg-red";
              }
            } else {
                clientDisplay = "SYSTEM";
                badgeText = "LOG";
                message = payload;
            }

            logEntries.push({ timestamp, clientDisplay, badgeText, badgeClass, message });

          } catch (err) { console.warn("Skip:", line); }
        });

        updateUI(stats, logEntries);
      }

      // --- UI Updates ---
      function updateUI(stats, logEntries) {
        // 1. Update Number Cards
        totalRequestsEl.textContent = stats.totalRequests;
        cacheHitsEl.textContent = stats.cacheHits;
        cacheMissesEl.textContent = stats.cacheMisses;
        httpsTunnelsEl.textContent = stats.httpsTunnels;

        const httpReqs = stats.cacheHits + stats.cacheMisses;
        const rate = httpReqs > 0 ? (stats.cacheHits / httpReqs) * 100 : 0;
        hitRateEl.textContent = rate.toFixed(1) + "%";

        // 2. Update Chart
        updateChart(stats.cacheHits, stats.cacheMisses);

        // 3. Update Feed
        renderLogFeed(logEntries);
      }

      function updateChart(hits, misses) {
        if (cacheChart) cacheChart.destroy();

        if (hits === 0 && misses === 0) {
          chartErrorEl.style.display = "block";
          document.getElementById("cacheChart").style.display = "none";
          return;
        }

        chartErrorEl.style.display = "none";
        const canvas = document.getElementById("cacheChart");
        canvas.style.display = "block";

        cacheChart = new Chart(chartCtx, {
          type: "doughnut",
          data: {
            labels: ["Cache Hits", "Cache Misses"],
            datasets: [
              {
                data: [hits, misses],
                backgroundColor: ["#22c55e", "#ef4444"],
                borderColor: "#1f2937",
                borderWidth: 2,
                hoverOffset: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "75%",
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: "#d1d5db",
                  padding: 20,
                  font: { family: "Inter" },
                },
              },
            },
          },
        });
      }

      function renderLogFeed(entries) {
        logFeedEl.innerHTML = "";

        if (entries.length === 0) {
          logFeedEl.innerHTML =
            '<div style="text-align: center; color: #6b7280; padding-top: 2rem;">No parsable log data found.</div>';
          return;
        }

        const fragment = document.createDocumentFragment();

        // Limit to last 2000 lines for performance if file is huge
        const displayEntries =
          entries.length > 2000 ? entries.slice(-2000) : entries;

        displayEntries.forEach((entry) => {
          const row = document.createElement("div");
          row.className = "log-entry";

          // Clean timestamp: remove date and ms if present, keep HH:MM:SS
          let timeDisplay = entry.timestamp;
          if (timeDisplay.includes(' ')) {
             // Split by space to get time, then split by '.' to remove ms
             timeDisplay = timeDisplay.split(' ')[1].split('.')[0]; 
          }

          // Highlight URLs in message
          let msgHtml = entry.message.replace(
            /(https?:\/\/[^\s]+)/g,
            '<span class="text-highlight">$1</span>',
          );

          row.innerHTML = `
            <span class="log-time" title="${entry.timestamp}">${timeDisplay}</span>
            <span class="log-badge ${entry.badgeClass}">${entry.badgeText}</span>
            <span class="log-client" title="${entry.clientDisplay}">${entry.clientDisplay}</span>
            <span class="log-msg">${msgHtml}</span>
          `;
          fragment.appendChild(row);
        });

        logFeedEl.appendChild(fragment);

        // Auto-scroll to bottom
        setTimeout(() => {
          logFeedEl.scrollTop = logFeedEl.scrollHeight;
        }, 50);
      }
    </script>
  </body>
</html>